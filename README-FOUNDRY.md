# Null Protocol - Foundry Development Guide

This document describes the new Foundry-based development setup for the Null Protocol project.

## ğŸš€ Quick Start

### Prerequisites

- [Foundry](https://book.getfoundry.sh/getting-started/installation)
- Node.js 18+
- npm or yarn

### Installation

```bash
# Install Foundry (if not already installed)
curl -L https://foundry.paradigm.xyz | bash
foundryup

# Clone and setup
git clone https://github.com/null-foundation/protocol.git
cd protocol
npm install
forge install
```

## ğŸ—ï¸ Build and Test

### Compile Contracts

```bash
# Compile all contracts
forge build

# Clean and rebuild
forge clean && forge build
```

### Run Tests

```bash
# Run all tests
forge test

# Run unit tests only
npm run test:unit

# Run invariant tests
npm run test:invariant

# Run fuzz tests with more iterations
npm run test:fuzz

# Run with gas reporting
npm run test:gas

# Run with coverage
npm run test:coverage
```

### Test Profiles

The project includes different test profiles in `foundry.toml`:

- **default**: Standard testing (1000 fuzz runs, 256 invariant runs)
- **ci**: CI/CD testing (10000 fuzz runs, 1000 invariant runs)
- **lite**: Quick testing (100 fuzz runs, 10 invariant runs)

```bash
# Use specific profile
forge test --profile ci
```

## ğŸ” Security Analysis

### Slither Static Analysis

```bash
# Run Slither on all contracts
npm run security:slither

# Run on specific contract
slither src/CanonRegistry.sol --config-file slither.config.json
```

### Echidna Property Testing

```bash
# Run Echidna property tests
npm run security:echidna

# Run specific property test
echidna echidna/CanonRegistry.echidna.sol --test-mode property
```

## ğŸš€ Deployment

### Local Development

```bash
# Start local Anvil node
npm run anvil

# Deploy to local network
npm run deploy:local
```

### Testnet Deployment

```bash
# Deploy to Base Sepolia
npm run deploy:testnet
```

### Mainnet Deployment

```bash
# Deploy to Ethereum mainnet
npm run deploy:mainnet
```

## ğŸ“ Project Structure

```
null-protocol/
â”œâ”€â”€ src/                    # Solidity contracts
â”‚   â”œâ”€â”€ CanonRegistry.sol   # Main registry contract
â”‚   â”œâ”€â”€ MaskSBT.sol         # Soulbound token contract
â”‚   â””â”€â”€ interfaces/         # Contract interfaces
â”œâ”€â”€ test/                   # Foundry tests
â”‚   â”œâ”€â”€ CanonRegistry.t.sol
â”‚   â”œâ”€â”€ MaskSBT.t.sol
â”‚   â”œâ”€â”€ CanonRegistry.invariant.t.sol
â”‚   â””â”€â”€ MaskSBT.invariant.t.sol
â”œâ”€â”€ echidna/                # Echidna property tests
â”‚   â”œâ”€â”€ CanonRegistry.echidna.sol
â”‚   â””â”€â”€ MaskSBT.echidna.sol
â”œâ”€â”€ script/                 # Deployment scripts
â”‚   â””â”€â”€ Deploy.s.sol
â”œâ”€â”€ lib/                    # Dependencies
â”‚   â”œâ”€â”€ forge-std/
â”‚   â””â”€â”€ openzeppelin-contracts/
â”œâ”€â”€ foundry.toml            # Foundry configuration
â”œâ”€â”€ slither.config.json     # Slither configuration
â””â”€â”€ echidna.yaml           # Echidna configuration
```

## ğŸ”§ Configuration

### Foundry Configuration (`foundry.toml`)

```toml
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc = "0.8.20"
optimizer = true
optimizer_runs = 200
via_ir = true
fuzz = { runs = 1000, max_test_rejects = 65536 }
invariant = { runs = 256, depth = 15 }
gas_reports = ["*"]
```

### Slither Configuration (`slither.config.json`)

```json
{
  "filter_paths": ["lib/", "node_modules/", "test/"],
  "exclude_dependencies": true,
  "exclude_optimization": true,
  "json": "slither-report.json"
}
```

## ğŸ§ª Testing Strategy

### Unit Tests
- Test individual functions and edge cases
- Use `test` prefix in function names
- Located in `test/*.t.sol` files

### Invariant Tests
- Test system-wide properties that should always hold
- Use `invariant_` prefix in function names
- Located in `test/*.invariant.t.sol` files

### Fuzz Tests
- Automatically generated by Foundry
- Test functions with random inputs
- Configured in `foundry.toml`

### Property Tests (Echidna)
- Test high-level properties
- Use `echidna_` prefix in function names
- Located in `echidna/*.echidna.sol` files

## ğŸ”’ Security Features

### Custom Errors
All contracts use custom errors instead of `require()` statements for better gas efficiency and clearer error messages.

### Access Control
- Role-based access control using OpenZeppelin's `AccessControl`
- Admin, minter, and relayer roles
- Pausable functionality for emergency stops

### Reentrancy Protection
- `nonReentrant` modifier on all state-changing functions
- Pull payment pattern for fee distribution

### Static Analysis
- Slither for vulnerability detection
- Echidna for property-based testing
- Automated security checks in CI/CD

## ğŸš€ CI/CD Pipeline

The project includes a comprehensive GitHub Actions workflow (`.github/workflows/forge-ci.yml`) that:

1. **Compiles** contracts and checks formatting
2. **Runs tests** (unit, invariant, fuzz)
3. **Performs static analysis** with Slither
4. **Analyzes gas usage** and optimization
5. **Runs security checks**
6. **Deploys to testnet** (on main branch)
7. **Notifies** on completion

## ğŸ“Š Gas Optimization

### Current Gas Usage
- CanonRegistry deployment: ~2.5M gas
- MaskSBT deployment: ~3.2M gas
- Anchor operation: ~150K gas
- Mint operation: ~200K gas

### Optimization Features
- Custom errors instead of strings
- Packed structs where possible
- Efficient storage patterns
- Minimal external calls

## ğŸ› Debugging

### Foundry Debugging

```bash
# Run with verbose output
forge test -vvv

# Run specific test with traces
forge test --match-test testSpecificFunction -vvvv

# Debug failed test
forge test --match-test testFailedFunction --debug
```

### Gas Analysis

```bash
# Generate gas report
forge test --gas-report

# Analyze specific function
forge test --match-test testSpecificFunction --gas-report
```

## ğŸ“š Additional Resources

- [Foundry Book](https://book.getfoundry.sh/)
- [Slither Documentation](https://github.com/crytic/slither)
- [Echidna Documentation](https://github.com/crytic/echidna)
- [OpenZeppelin Contracts](https://docs.openzeppelin.com/contracts/)

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Write tests for your changes
4. Run the full test suite: `forge test`
5. Run security analysis: `npm run security:slither`
6. Submit a pull request

## ğŸ“„ License

MIT License - see LICENSE file for details.




