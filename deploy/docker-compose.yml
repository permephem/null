version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    container_name: null_pg
    environment:
      POSTGRES_DB: null_indexer
      POSTGRES_USER: null_user
      POSTGRES_PASSWORD: change-me
    ports: ["5432:5432"]
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./apps/indexer-tickets/sql/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U null_user -d null_indexer"]
      interval: 10s
      timeout: 5s
      retries: 5

  ipfs:
    image: ipfs/kubo:release
    container_name: null_ipfs
    ports:
      - "5001:5001"   # API
      - "8080:8080"   # Gateway
    environment:
      IPFS_PROFILE: server
    volumes:
      - ipfs_staging:/export
      - ipfs_data:/data/ipfs
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 15s
      timeout: 5s
      retries: 10

  pinning-adapter:
    build: ./apps/pinning-adapter
    container_name: null_pinner
    environment:
      IPFS_API_URL: http://ipfs:5001
      PINNING_JWT: change-me # simple bearer for relayer auth
    ports: ["8789:8789"]
    depends_on:
      ipfs:
        condition: service_healthy

  relayer-tickets:
    build: ./apps/relayer-tickets
    container_name: null_relayer
    environment:
      PORT: 8787
      VENUE_HMAC_KEY: change-me-super-secret
      RPC_URL: ${RPC_URL-http://localhost:8545}
      CANON_ADDRESS: 0xCanonRegistryAddress
      FOUNDATION_ADDRESS: 0xFoundation
      RELAYER_PK: 0xabcdef... # DO NOT COMMIT REAL KEYS
      FEE_WEI_ISSUE: "0"
      FEE_WEI_TRANSFER: "0"
      FEE_WEI_REVOKE: "0"
      PINNER_BASE: http://pinning-adapter:8789
      PINNER_TOKEN: change-me
    ports: ["8787:8787"]
    depends_on:
      - pinning-adapter
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8787/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  indexer-tickets:
    build: ./apps/indexer-tickets
    container_name: null_indexer
    environment:
      RPC_URL: ${RPC_URL-http://localhost:8545}
      CANON_ADDRESS: 0xCanonRegistryAddress
      CANON_TOPIC_TICKETS: "4"
      PGHOST: postgres
      PGPORT: "5432"
      PGDATABASE: null_indexer
      PGUSER: null_user
      PGPASSWORD: change-me
      START_BLOCK: "0"
      CONFIRMATIONS: "5"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  pg_data:
  ipfs_staging:
  ipfs_data:
